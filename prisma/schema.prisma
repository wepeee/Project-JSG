// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
  // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
  // Further reading:
  // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
  // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
  url      = env("DATABASE_URL")
}

enum Role {
  SUPERADMIN
  ADMIN
  PPIC
  OPERATOR
  MASTER
}

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String   @db.VarChar(255)
  role         Role     @default(ADMIN)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Mesin

enum Uom {
  sheet
  pcs
  meter
  cm
}

model Machine {
  id                Int     @id @default(autoincrement())
  name              String
  stdOutputPerHour  Int
  stdOutputPerShift Int
  uom               Uom
  remark            String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  proSteps  ProStep[]
}

// model MachineCapability {
//   // stepId manual: 1=FRONT,2=BACK,4=CUTTING...
//   stepId        Int

//   machineId     Int
//   machine       Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)

//   name          String   // FRONT/BACK/OPV
//   fullName      String   // "SPEEDMASTER SX-74 FRONT"
//   standardSpeed Int
//   uom           String
//   remark        String?

// //   dailyReports  DailyReport[]

//   @@id([machineId, stepId])          // âœ… ini kuncinya
//   @@unique([machineId, name])        // optional tapi bagus
//   @@index([machineId])
// }

// material / bahan baku

model Material {
  id               Int               @id @default(autoincrement())
  name             String            @unique
  uom              String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  proStepMaterials ProStepMaterial[]
}

enum ProStatus {
  OPEN
  IN_PROGRESS
  DONE
  CANCELLED
}

model Process {
  id   Int    @id @default(autoincrement())
  code String @unique @db.VarChar(2) // WAJIB 2 digit: "11"
  name String @unique

  pros Pro[]
}

model ProSequence {
  // prefix = (processCode 2 digit) + (MM 2 digit) + (YY 2 digit) = 6 digit
  prefix String @id @db.VarChar(6)
  last   Int
}



enum ProType {
  PAPER
  RIGID
  OTHER
}

model Pro {
  id          Int       @id @default(autoincrement())
  proNumber   String    @unique @db.VarChar(9)
  productName String
  qtyPoPcs    Int
  startDate   DateTime?
  status      ProStatus @default(OPEN)
  type        ProType   @default(PAPER)

  processId   Int?
  process     Process?  @relation(fields: [processId], references: [id])

  steps ProStep[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProStep {
  id    Int @id @default(autoincrement())
  proId Int
  pro   Pro @relation(fields: [proId], references: [id], onDelete: Cascade)

  orderNo   Int // 1,2,3...
  
  up              Int?
  estimatedShifts Int?

  startDate       DateTime?

  machineId Int?
  machine   Machine? @relation(fields: [machineId], references: [id])

  partNumber String?

  materials ProStepMaterial[]

  @@unique([proId, orderNo])
  @@index([proId])
}

model ProStepMaterial {
  id     Int     @id @default(autoincrement())
  stepId Int
  step   ProStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  materialId Int
  material   Material @relation(fields: [materialId], references: [id])

  qtyReq Decimal @db.Decimal(12, 3)

  @@unique([stepId, materialId])
  @@index([stepId])
}
